<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SJM Admin | Jewellery & Locker</title>
    <style>
        :root { --bg: #1a1a1a; --panel: #2c2c2c; --gold: #d4af37; --text: #eee; --danger: #d9534f; --success: #28a745; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; }

        /* Tabs */
        .tabs { display: flex; border-bottom: 2px solid #444; margin-bottom: 20px; }
        .tab-btn { padding: 15px 30px; background: none; border: none; color: #888; font-size: 1.1rem; cursor: pointer; transition: 0.3s; }
        .tab-btn.active { color: var(--gold); border-bottom: 3px solid var(--gold); font-weight: bold; }
        .section { display: none; animation: fade 0.4s; }
        .section.active { display: block; }
        @keyframes fade { from { opacity: 0; } to { opacity: 1; } }

        /* UI Elements */
        .card { background: var(--panel); padding: 25px; border-radius: 8px; margin-bottom: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        
        input, select { width: 100%; padding: 10px; background: #333; border: 1px solid #555; color: white; border-radius: 4px; margin-bottom: 10px; }
        button { padding: 10px 15px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; }
        .btn-gold { background: var(--gold); color: #1a1a1a; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-toggle { background: #555; color: white; font-size: 0.8rem; }
        .active-user { background: var(--success); }

        /* Tables */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { text-align: left; padding: 12px; color: var(--gold); border-bottom: 1px solid #555; }
        td { padding: 12px; border-bottom: 1px solid #333; }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: var(--panel); padding: 30px; width: 400px; border-radius: 8px; border-top: 4px solid var(--gold); }
        
        /* Badges */
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; }
        .badge-in { background: #007bff; color: white; } /* IN_LOCKER */
        .badge-out { background: var(--success); color: white; } /* ON_DISPLAY */
    </style>
</head>
<body>

<h2 style="color:var(--gold)">ðŸ’Ž Admin Control Panel</h2>

<div class="tabs">
    <button class="tab-btn active" onclick="switchTab('jewellery')">1. Jewellery Management</button>
    <button class="tab-btn" onclick="switchTab('locker')">2. Locker Verification</button>
    <button class="tab-btn" onclick="switchTab('users')">3. User Management</button>
</div>

<div id="jewellery" class="section active">
    <div class="card">
        <h3>Add New Jewellery (Task 1.1.2)</h3>
        <div class="grid">
            <input type="text" id="jName" placeholder="Item Name">
            <input type="text" id="jType" placeholder="Type (e.g. Ring)">
            <input type="text" id="jMat" placeholder="Material (e.g. 22k Gold)">
            <input type="number" id="jWeight" placeholder="Weight (g)">
            <input type="number" id="jPrice" placeholder="Price ($)">
            <button class="btn-gold" onclick="addJewellery()">+ Add Item</button>
        </div>
    </div>
    
    <div class="card">
        <h3>Inventory List (Task 1.1.1)</h3>
        <table>
            <thead><tr><th>ID</th><th>Name</th><th>Type</th><th>Status</th><th>Actions</th></tr></thead>
            <tbody id="jewelleryTable"></tbody>
        </table>
    </div>
</div>

<div id="locker" class="section">
    <div class="card">
        <h3>Locker Processing (Task 1.2.1 & 1.2.2)</h3>
        <p style="color:#ccc; font-size:0.9rem; margin-bottom:15px;">Select an item to verify storage or retrieval.</p>
        
        <form id="lockerForm">
            <label>Select Item to Verify:</label>
            <select id="lockerJewellerySelect" onchange="loadVerificationHistory()"></select>
            
            <label>Action Type:</label>
            <select id="verificationType">
                <option value="BEFORE_STORAGE">â¬‡ Put into Locker (Before-Storage)</option>
                <option value="AFTER_STORAGE">â¬† Retrieve from Locker (After-Storage)</option>
            </select>
            
            <label>Notes / Visual Check:</label>
            <input type="text" id="lockerNotes" placeholder="e.g. No scratches observed...">
            
            <label>Upload Proof Image (Task 1.2.3):</label>
            <input type="file" id="lockerImage" accept="image/*">
            
            <button type="submit" class="btn-gold" style="width:100%; margin-top:10px;">Verify & Update Status</button>
        </form>
    </div>

    <div class="card">
        <h3>Verification Log & Results</h3>
        <table>
            <thead><tr><th>Date</th><th>Type</th><th>Notes</th><th>Proof</th></tr></thead>
            <tbody id="lockerLogTable"></tbody>
        </table>
    </div>
</div>

<div id="users" class="section">
    <div class="card">
        <h3>Create New User (Task 1.3.2)</h3>
        <div class="grid">
            <input type="text" id="uName" placeholder="Username">
            <input type="email" id="uEmail" placeholder="Email Address">
            <select id="uRole">
                <option value="Admin">Admin</option>
                <option value="Manager">Manager</option>
                <option value="Supplier">Supplier</option>
                <option value="Customer">Customer</option>
            </select>
            <button class="btn-gold" onclick="addUser()">Create User</button>
        </div>
    </div>

    <div class="card">
        <h3>System Users (Task 1.3.1)</h3>
        <table>
            <thead><tr><th>Username</th><th>Email</th><th>Role</th><th>Status (Task 1.3.4)</th><th>Actions</th></tr></thead>
            <tbody id="userTable"></tbody>
        </table>
    </div>
</div>

<div id="editJModal" class="modal">
    <div class="modal-content">
        <h3>Edit Jewellery</h3>
        <input type="hidden" id="editJId">
        <input type="text" id="editJName">
        <input type="text" id="editJType">
        <input type="text" id="editJMat">
        <input type="number" id="editJWeight">
        <input type="number" id="editJPrice">
        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:15px;">
            <button onclick="closeModal('editJModal')" style="background:#555; color:white;">Cancel</button>
            <button onclick="updateJewellery()" class="btn-gold">Save Changes</button>
        </div>
    </div>
</div>

<div id="editUModal" class="modal">
    <div class="modal-content">
        <h3>Edit User Role</h3>
        <input type="hidden" id="editUId">
        <p id="editUNameDisplay" style="color:var(--gold)"></p>
        <select id="editURole">
            <option value="Admin">Admin</option>
            <option value="Manager">Manager</option>
            <option value="Supplier">Supplier</option>
            <option value="Customer">Customer</option>
        </select>
        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:15px;">
            <button onclick="closeModal('editUModal')" style="background:#555; color:white;">Cancel</button>
            <button onclick="updateUserRole()" class="btn-gold">Update Role</button>
        </div>
    </div>
</div>

<script>
    const API = 'api';

    // --- TAB SWITCHING ---
    function switchTab(id) {
        document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        event.target.classList.add('active');
        if(id === 'jewellery') loadJewellery();
        if(id === 'users') loadUsers();
        if(id === 'locker') loadLockerOptions();
    }

    function closeModal(id) { document.getElementById(id).style.display = 'none'; }

    // --- 1. JEWELLERY MANAGEMENT JS ---
    async function loadJewellery() {
        const res = await fetch(`${API}/manage_jewellery.php`);
        const data = await res.json();
        const tbody = document.getElementById('jewelleryTable');
        tbody.innerHTML = '';
        
        data.forEach(item => {
            const statusBadge = item.status === 'IN_LOCKER' 
                ? `<span class="badge badge-in">ðŸ”’ In Locker</span>` 
                : `<span class="badge badge-out">âœ¨ On Display</span>`;

            tbody.innerHTML += `
                <tr>
                    <td>${item.jewellery_id}</td>
                    <td>${item.name}</td>
                    <td>${item.type}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="btn-toggle" onclick='openEditJ(${JSON.stringify(item)})'>Edit</button>
                        <button class="btn-danger" style="padding:5px 10px;" onclick="deleteJewellery(${item.jewellery_id})">ðŸ—‘</button>
                    </td>
                </tr>
            `;
        });
    }

    async function addJewellery() {
        const data = {
            name: document.getElementById('jName').value,
            type: document.getElementById('jType').value,
            material: document.getElementById('jMat').value,
            weight: document.getElementById('jWeight').value,
            price: document.getElementById('jPrice').value
        };
        await fetch(`${API}/manage_jewellery.php`, { method: 'POST', body: JSON.stringify(data) });
        loadJewellery();
    }

    function openEditJ(item) {
        document.getElementById('editJId').value = item.jewellery_id;
        document.getElementById('editJName').value = item.name;
        document.getElementById('editJType').value = item.type;
        document.getElementById('editJMat').value = item.material;
        document.getElementById('editJWeight').value = item.weight_grams;
        document.getElementById('editJPrice').value = item.price;
        document.getElementById('editJModal').style.display = 'flex';
    }

    async function updateJewellery() {
        const data = {
            id: document.getElementById('editJId').value,
            name: document.getElementById('editJName').value,
            type: document.getElementById('editJType').value,
            material: document.getElementById('editJMat').value,
            weight: document.getElementById('editJWeight').value,
            price: document.getElementById('editJPrice').value
        };
        await fetch(`${API}/manage_jewellery.php`, { method: 'PUT', body: JSON.stringify(data) });
        closeModal('editJModal');
        loadJewellery();
    }

    async function deleteJewellery(id) {
        if(confirm("Are you sure you want to delete this item?")) { // Task 1.1.4 Popup
            await fetch(`${API}/manage_jewellery.php?id=${id}`, { method: 'DELETE' });
            loadJewellery();
        }
    }

    // --- 2. LOCKER VERIFICATION JS ---
    async function loadLockerOptions() {
        const res = await fetch(`${API}/manage_jewellery.php`);
        const data = await res.json();
        const select = document.getElementById('lockerJewellerySelect');
        select.innerHTML = '<option value="">-- Select Item --</option>';
        data.forEach(item => {
            select.innerHTML += `<option value="${item.jewellery_id}">${item.name} (${item.status})</option>`;
        });
    }

    document.getElementById('lockerForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData();
        formData.append('jewellery_id', document.getElementById('lockerJewellerySelect').value);
        formData.append('verification_type', document.getElementById('verificationType').value);
        formData.append('notes', document.getElementById('lockerNotes').value);
        if(document.getElementById('lockerImage').files[0]) {
            formData.append('proof_image', document.getElementById('lockerImage').files[0]);
        }

        const res = await fetch(`${API}/locker_process.php`, { method: 'POST', body: formData });
        const result = await res.json();
        alert(result.message); // Task 1.2.4 Result Feedback
        loadLockerOptions(); // Refresh status in dropdown
        loadVerificationHistory(); // Refresh logs
    });

    async function loadVerificationHistory() {
        const id = document.getElementById('lockerJewellerySelect').value;
        if(!id) return;
        const res = await fetch(`${API}/locker_process.php?jewellery_id=${id}`);
        const data = await res.json();
        
        const tbody = document.getElementById('lockerLogTable');
        tbody.innerHTML = '';
        data.forEach(log => {
            tbody.innerHTML += `
                <tr>
                    <td>${log.verification_date}</td>
                    <td style="color:${log.verification_type === 'BEFORE_STORAGE' ? '#007bff' : '#28a745'}">${log.verification_type}</td>
                    <td>${log.notes}</td>
                    <td>${log.proof_image_path ? `<a href="${log.proof_image_path}" target="_blank" style="color:var(--gold)">View Image</a>` : 'None'}</td>
                </tr>
            `;
        });
    }

    // --- 3. USER MANAGEMENT JS ---
    async function loadUsers() {
        const res = await fetch(`${API}/manage_users.php`);
        const data = await res.json();
        const tbody = document.getElementById('userTable');
        tbody.innerHTML = '';

        data.forEach(user => {
            // Task 1.3.4: Toggle UI
            const activeClass = user.is_active === 't' ? 'active-user' : 'btn-danger';
            const activeText = user.is_active === 't' ? 'Active' : 'Inactive';
            
            tbody.innerHTML += `
                <tr>
                    <td>${user.username}</td>
                    <td>${user.email}</td>
                    <td>${user.role}</td>
                    <td>
                        <button class="btn-toggle ${activeClass}" onclick="toggleUser(${user.user_id})">${activeText}</button>
                    </td>
                    <td>
                        <button class="btn-gold" style="padding:5px;" onclick='openEditU(${JSON.stringify(user)})'>Edit Role</button>
                    </td>
                </tr>
            `;
        });
    }

    async function addUser() {
        const data = {
            username: document.getElementById('uName').value,
            email: document.getElementById('uEmail').value,
            role: document.getElementById('uRole').value
        };
        await fetch(`${API}/manage_users.php`, { method: 'POST', body: JSON.stringify(data) });
        loadUsers();
    }

    function openEditU(user) {
        document.getElementById('editUId').value = user.user_id;
        document.getElementById('editUNameDisplay').innerText = "Editing: " + user.username;
        document.getElementById('editURole').value = user.role;
        document.getElementById('editUModal').style.display = 'flex';
    }

    async function updateUserRole() {
        const data = {
            user_id: document.getElementById('editUId').value,
            role: document.getElementById('editURole').value
        };
        await fetch(`${API}/manage_users.php`, { method: 'PUT', body: JSON.stringify(data) });
        closeModal('editUModal');
        loadUsers();
    }

    async function toggleUser(id) {
        await fetch(`${API}/manage_users.php`, { method: 'PATCH', body: JSON.stringify({user_id: id}) });
        loadUsers();
    }

    // Init
    loadJewellery();
</script>

</body>
</html>